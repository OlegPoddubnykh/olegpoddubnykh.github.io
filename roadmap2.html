<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imot.io Marketing Roadmap 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --okr1: #e74c3c;
            --okr2: #2ecc71;
            --okr3: #f1c40f;
            --okr4: #9b59b6;
            --bg: #f8f9fa;
            --text: #2c3e50;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        select, button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: 0.2s;
        }

        select:hover, button:hover {
            border-color: var(--okr1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #adminButton {
            background-color: var(--okr1);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
        }

        #adminButton:hover {
            background-color: #c0392b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.2);
        }

        button.active {
            background-color: var(--text);
            color: white;
        }

        .gantt-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .gantt-chart {
            display: grid;
            gap: 5px;
            min-width: 100%;
            padding: 20px 0;
            grid-auto-rows: minmax(45px, auto);
        }

        .month-header {
            text-align: center;
            padding: 10px;
            font-weight: 500;
            position: sticky;
            top: 0;
            background: white;
            z-index: 2;
            border-bottom: 2px solid var(--bg);
        }

        .task-row {
            display: contents;
            position: relative;
        }

        .task-info {
            padding: 12px;
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
            border-right: 2px solid var(--bg);
        }

        .task-bar {
            height: 36px;
            border-radius: 6px;
            margin: 4px 0;
            position: relative;
            transition: 0.2s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            color: white;
            font-size: 0.9em;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .task-bar.in-progress {
            border: 2px solid white;
        }
        
        .task-bar.completed {
            opacity: 0.7;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.2) 5px, rgba(255,255,255,0.2) 10px);
        }
        
        .task-bar.not-started {
            opacity: 0.9;
        }

        .task-bar:hover {
            filter: brightness(1.1);
            transform: scaleY(1.05);
            z-index: 3;
        }

        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: 0.2s;
            min-width: 300px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 20px;
            transition: 0.2s;
        }

        .legend-item:hover {
            background: rgba(0,0,0,0.05);
        }

        .legend-item.filtered {
            opacity: 0.5;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .stats {
            margin-top: 30px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stats-title {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            padding: 15px;
            border-radius: 8px;
            background: var(--bg);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: rgba(44, 62, 80, 0.7);
            font-size: 0.9em;
        }

        .staff-stats {
            margin-top: 30px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .staff-stats-title {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .staff-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .staff-card {
            padding: 15px;
            border-radius: 8px;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .staff-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .staff-tasks {
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
        }
        
        .staff-bar {
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .staff-progress {
            height: 100%;
            border-radius: 3px;
            background-color: var(--text);
        }
        
        .draggable {
            cursor: grab;
        }
        
        .draggable:active {
            cursor: grabbing;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .gantt-chart {
                grid-template-columns: 200px repeat(12, 100px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">
                <h1>üöÄ Imot.io Marketing Roadmap 2025</h1>
            </div>
            <div class="filters">
                <select id="okrFilter">
                    <option value="all">–í—Å–µ OKR</option>
                    <option value="1">Objective 1: +2 –º–ª–Ω MRR</option>
                    <option value="2">Objective 2: –£–ø—Ä–æ—â–µ–Ω–∏–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è</option>
                    <option value="3">Objective 3: ESOV</option>
                    <option value="4">Objective 4: –ü—Ä–æ—Ü–µ—Å—Å—ã</option>
                </select>
                <select id="ownerFilter">
                    <option value="all">–í—Å–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</option>
                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </select>
                <select id="periodFilter">
                    <option value="all">–í–µ—Å—å –ø–µ—Ä–∏–æ–¥</option>
                    <option value="q1">Q1 2025</option>
                    <option value="q2">Q2 2025</option>
                    <option value="q3">Q3 2025</option>
                    <option value="q4">Q4 2025</option>
                </select>
                <button id="toggleView" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥">–ö–≤–∞—Ä—Ç–∞–ª—å–Ω–æ</button>
                <button id="adminButton">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <div class="gantt-container">
            <div class="gantt-chart" id="ganttChart"></div>
        </div>

        <div class="legend">
            <div class="legend-item" data-okr="1">
                <div class="legend-color" style="background: var(--okr1)"></div>
                <span>Objective 1: +2 –º–ª–Ω MRR</span>
            </div>
            <div class="legend-item" data-okr="2">
                <div class="legend-color" style="background: var(--okr2)"></div>
                <span>Objective 2: –£–ø—Ä–æ—â–µ–Ω–∏–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è</span>
            </div>
            <div class="legend-item" data-okr="3">
                <div class="legend-color" style="background: var(--okr3)"></div>
                <span>Objective 3: ESOV</span>
            </div>
            <div class="legend-item" data-okr="4">
                <div class="legend-color" style="background: var(--okr4)"></div>
                <span>Objective 4: –ü—Ä–æ—Ü–µ—Å—Å—ã</span>
            </div>
        </div>

        <div class="stats">
            <h2 class="stats-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="inProgressTasks">0</div>
                    <div class="stat-label">–ó–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="upcomingTasks">0</div>
                    <div class="stat-label">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∑–∞–¥–∞—á</div>
                </div>
            </div>
        </div>
        
        <div class="staff-stats">
            <h2 class="staff-stats-title">üë• –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º</h2>
            <div class="staff-stats-grid" id="staffStats">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

<script>
// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON —Ñ–∞–π–ª–∞
async function loadTasks() {
    try {
        const response = await fetch('roadmap-data.json');
        const data = await response.json();
        return data.roadmap;
    } catch (error) {
        console.error('Error loading tasks:', error);
        return [];
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
let currentView = 'monthly'; // monthly –∏–ª–∏ quarterly
let filteredOkrs = [];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã 2025 –≥–æ–¥–∞ (–¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏)
function getCurrentDateFor2025Demo() {
    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
    const realNow = new Date();
    
    // –°–æ–∑–¥–∞–µ–º "–≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é" –¥–∞—Ç—É 2025 –≥–æ–¥–∞ —Å —Ç–µ–º –∂–µ –º–µ—Å—è—Ü–µ–º –∏ –¥–Ω–µ–º
    const demoDate = new Date(2025, realNow.getMonth(), realNow.getDate());
    
    return demoDate;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–¥–∞—á –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
function updateTaskStatuses(tasks) {
    const today = getCurrentDateFor2025Demo();
    
    tasks.forEach(task => {
        const startDate = new Date(task.start);
        const endDate = new Date(task.end);
        
        if (startDate <= today && endDate >= today) {
            task.status = 'in-progress';
        } else if (startDate > today) {
            task.status = 'not-started';
        } else if (endDate < today) {
            task.status = 'completed';
        }
    });
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º
function generateStaffStats(tasks) {
    const today = getCurrentDateFor2025Demo();
    const staffStatsContainer = document.getElementById('staffStats');
    staffStatsContainer.innerHTML = '';
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º
    const staffData = {};
    
    tasks.forEach(task => {
        if (task.owner) {
            const owners = task.owner.split(', ');
            owners.forEach(owner => {
                const normalizedOwner = owner.trim();
                
                if (!staffData[normalizedOwner]) {
                    staffData[normalizedOwner] = {
                        total: 0,
                        inProgress: 0,
                        completed: 0,
                        upcoming: 0
                    };
                }
                
                staffData[normalizedOwner].total++;
                
                const startDate = new Date(task.start);
                const endDate = new Date(task.end);
                
                if (startDate <= today && endDate >= today) {
                    staffData[normalizedOwner].inProgress++;
                } else if (endDate < today) {
                    staffData[normalizedOwner].completed++;
                } else {
                    staffData[normalizedOwner].upcoming++;
                }
            });
        }
    });
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    const staffArray = Object.entries(staffData).map(([name, stats]) => ({
        name,
        ...stats
    }));
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–¥–∞—á (–æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É)
    staffArray.sort((a, b) => b.total - a.total);
    
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    staffArray.forEach(staff => {
        const card = document.createElement('div');
        card.className = 'staff-card';
        
        // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        const progressPercent = (staff.completed / staff.total) * 100;
        
        card.innerHTML = `
            <div class="staff-name">
                <span>${staff.name}</span>
                <span>${staff.total} –∑–∞–¥–∞—á</span>
            </div>
            <div class="staff-tasks">
                <span>–í —Ä–∞–±–æ—Ç–µ: ${staff.inProgress}</span>
                <span>–ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${staff.completed}</span>
                <span>–ü—Ä–µ–¥—Å—Ç–æ–∏—Ç: ${staff.upcoming}</span>
            </div>
            <div class="staff-bar">
                <div class="staff-progress" style="width: ${progressPercent}%"></div>
            </div>
        `;
        
        staffStatsContainer.appendChild(card);
    });
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∏–º–µ–Ω
function populateOwnerFilter(tasks) {
    const ownerFilter = document.getElementById('ownerFilter');
    const owners = new Set();
    
    tasks.forEach(task => {
        if (task.owner) {
            const taskOwners = task.owner.split(', ');
            taskOwners.forEach(owner => {
                // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω
                let normalizedOwner = owner.trim();
                if (normalizedOwner.toLowerCase() === '–∫–æ–Ω—Ç–µ–Ω—Ç' || normalizedOwner.toLowerCase() === '–∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä') {
                    normalizedOwner = '–ö–æ–Ω—Ç–µ–Ω—Ç';
                }
                owners.add(normalizedOwner);
            });
        }
    });
    
    const sortedOwners = Array.from(owners).sort();
    
    // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º
    while (ownerFilter.options.length > 1) {
        ownerFilter.remove(1);
    }
    
    sortedOwners.forEach(owner => {
        const option = document.createElement('option');
        option.value = owner;
        option.textContent = owner;
        ownerFilter.appendChild(option);
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStats(tasks) {
    const today = getCurrentDateFor2025Demo();
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
    const filteredTasks = tasks.filter(task => {
        const okrMatch = document.getElementById('okrFilter').value === 'all' || task.okr.toString() === document.getElementById('okrFilter').value;
        const ownerMatch = document.getElementById('ownerFilter').value === 'all' || task.owner.includes(document.getElementById('ownerFilter').value);
        return okrMatch && ownerMatch;
    });
    
    document.getElementById('totalTasks').textContent = filteredTasks.length;
    
    const inProgress = filteredTasks.filter(task => {
        const startDate = new Date(task.start);
        const endDate = new Date(task.end);
        return startDate <= today && endDate >= today;
    }).length;
    
    const completed = filteredTasks.filter(task => {
        const endDate = new Date(task.end);
        return endDate < today;
    }).length;
    
    const upcoming = filteredTasks.filter(task => {
        const startDate = new Date(task.start);
        return startDate > today;
    }).length;
    
    document.getElementById('inProgressTasks').textContent = inProgress;
    document.getElementById('completedTasks').textContent = completed;
    document.getElementById('upcomingTasks').textContent = upcoming;
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–∏–∞–≥—Ä–∞–º–º—ã –ì–∞–Ω—Ç–∞
function renderGantt(tasks) {
    const okrFilter = document.getElementById('okrFilter').value;
    const ownerFilter = document.getElementById('ownerFilter').value;
    const periodFilter = document.getElementById('periodFilter').value;
    
    const chart = document.getElementById('ganttChart');
    chart.innerHTML = '';
    
    let timeHeaders;
    let gridColumns;
    
    if (currentView === 'monthly') {
        timeHeaders = [
            '–ê–ø—Ä 2025', '–ú–∞–π 2025', '–ò—é–Ω 2025', '–ò—é–ª 2025', '–ê–≤–≥ 2025', '–°–µ–Ω 2025',
            '–û–∫—Ç 2025', '–ù–æ—è 2025', '–î–µ–∫ 2025'
        ];
        // –û–±–Ω–æ–≤–ª—è–µ–º CSS –¥–ª—è —Å–µ—Ç–∫–∏ –ø—Ä–∏ –º–µ—Å—è—á–Ω–æ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏
        chart.style.gridTemplateColumns = '300px repeat(9, 1fr)';
    } else {
        timeHeaders = ['Q2 2025', 'Q3 2025', 'Q4 2025'];
        // –û–±–Ω–æ–≤–ª—è–µ–º CSS –¥–ª—è —Å–µ—Ç–∫–∏ –ø—Ä–∏ –∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏  
        chart.style.gridTemplateColumns = '300px repeat(3, 1fr)';
    }
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const headerInfo = document.createElement('div');
    headerInfo.className = 'month-header';
    headerInfo.textContent = '–ó–∞–¥–∞—á–∏ –ø—Ä–æ–µ–∫—Ç–∞';
    chart.appendChild(headerInfo);
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤
    timeHeaders.forEach(header => {
        const headerCell = document.createElement('div');
        headerCell.className = 'month-header';
        headerCell.textContent = header;
        chart.appendChild(headerCell);
    });
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á
    const filteredTasks = tasks.filter(task => {
        const okrMatch = okrFilter === 'all' || task.okr.toString() === okrFilter;
        const ownerMatch = ownerFilter === 'all' || task.owner.includes(ownerFilter);
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–µ—Ä–∏–æ–¥—É
        let periodMatch = true;
        if (periodFilter !== 'all') {
            const startDate = new Date(task.start);
            const endDate = new Date(task.end);
            
            if (periodFilter === 'q1') {
                periodMatch = (startDate <= new Date('2025-03-31') && endDate >= new Date('2025-01-01'));
            } else if (periodFilter === 'q2') {
                periodMatch = (startDate <= new Date('2025-06-30') && endDate >= new Date('2025-04-01'));
            } else if (periodFilter === 'q3') {
                periodMatch = (startDate <= new Date('2025-09-30') && endDate >= new Date('2025-07-01'));
            } else if (periodFilter === 'q4') {
                periodMatch = (startDate <= new Date('2025-12-31') && endDate >= new Date('2025-10-01'));
            }
        }
        
        return okrMatch && ownerMatch && periodMatch;
    });
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ OKR, KR –∏ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞
    filteredTasks.sort((a, b) => {
        if (a.okr !== b.okr) return a.okr - b.okr;
        if (a.kr !== b.kr) return a.kr.localeCompare(b.kr);
        return new Date(a.start) - new Date(b.start);
    });
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–¥–∞—á
    filteredTasks.forEach(task => {
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ
        const info = document.createElement('div');
        info.className = 'task-info';
        info.innerHTML = `
            <div><strong>${task.kr}</strong> ${task.name}</div>
            <small>${task.owner || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ'}</small>
        `;
        chart.appendChild(info);
        
        // –°–æ–∑–¥–∞–µ–º —è—á–µ–π–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
        for (let i = 0; i < timeHeaders.length; i++) {
            const cell = document.createElement('div');
            
            const taskStartDate = new Date(task.start);
            const taskEndDate = new Date(task.end);
            let inPeriod = false;
            
            if (currentView === 'monthly') {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –∑–∞–¥–∞—á–∞ –≤ —ç—Ç–æ—Ç –º–µ—Å—è—Ü
                const monthYear = timeHeaders[i].split(' ');
                const month = getMonthNumber(monthYear[0]);
                const year = parseInt(monthYear[1]);
                
                const periodStart = new Date(year, month, 1);
                const periodEnd = new Date(year, month + 1, 0);
                
                inPeriod = (taskStartDate <= periodEnd && taskEndDate >= periodStart);
            } else {
                // –î–ª—è –∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
                const quarter = timeHeaders[i].split(' ')[0].substring(1);
                const year = parseInt(timeHeaders[i].split(' ')[1]);
                
                let quarterStart, quarterEnd;
                if (quarter === '2') {
                    quarterStart = new Date(year, 3, 1); // –ê–ø—Ä–µ–ª—å
                    quarterEnd = new Date(year, 5, 30); // –ò—é–Ω—å
                } else if (quarter === '3') {
                    quarterStart = new Date(year, 6, 1); // –ò—é–ª—å
                    quarterEnd = new Date(year, 8, 30); // –°–µ–Ω—Ç—è–±—Ä—å
                } else if (quarter === '4') {
                    quarterStart = new Date(year, 9, 1); // –û–∫—Ç—è–±—Ä—å
                    quarterEnd = new Date(year, 11, 31); // –î–µ–∫–∞–±—Ä—å
                }
                
                inPeriod = (taskStartDate <= quarterEnd && taskEndDate >= quarterStart);
            }
            
            // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ–µ
            if (inPeriod) {
                const bar = document.createElement('div');
                bar.className = `task-bar ${task.status}`;
                bar.style.backgroundColor = `var(--okr${task.okr})`;
                
                // –í –∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ –≤ –ø–æ–ª–æ—Å—É
                if (currentView === 'quarterly') {
                    bar.textContent = task.name;
                }
                
                // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
                bar.addEventListener('mouseover', (e) => {
                    const tooltip = document.getElementById('tooltip');
                    
                    // –û–ø—Ä–µ–¥–µ–ª–∏–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    let statusText = '';
                    if (task.status === 'in-progress') {
                        statusText = '–í —Ä–∞–±–æ—Ç–µ';
                    } else if (task.status === 'completed') {
                        statusText = '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
                    } else {
                        statusText = '–ù–µ –Ω–∞—á–∞—Ç–æ';
                    }
                    
                    tooltip.innerHTML = `
                        <strong>${task.name}</strong><br>
                        <small>OKR ${task.okr} ‚Ä¢ KR ${task.kr}</small><br><br>
                        üìÖ ${formatDate(task.start)} - ${formatDate(task.end)}<br>
                        üë§ ${task.owner || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ'}<br>
                        üìä ${task.metrics}<br>
                        üîÑ <strong>${statusText}</strong>
                    `;
                    tooltip.style.opacity = 1;
                    tooltip.style.left = `${e.pageX + 15}px`;
                    tooltip.style.top = `${e.pageY + 15}px`;
                });

                bar.addEventListener('mouseout', () => {
                    document.getElementById('tooltip').style.opacity = 0;
                });

                cell.appendChild(bar);
            }
            
            chart.appendChild(cell);
        }
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    updateStats(tasks);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getMonthNumber(monthName) {
    const months = {
        '–Ø–Ω–≤': 0, '–§–µ–≤': 1, '–ú–∞—Ä': 2, '–ê–ø—Ä': 3, '–ú–∞–π': 4, '–ò—é–Ω': 5,
        '–ò—é–ª': 6, '–ê–≤–≥': 7, '–°–µ–Ω': 8, '–û–∫—Ç': 9, '–ù–æ—è': 10, '–î–µ–∫': 11
    };
    return months[monthName];
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è (drag-and-scroll) –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
function setupDragToScroll() {
    const container = document.querySelector('.gantt-container');
    let isDragging = false;
    let startX;
    let scrollLeft;

    container.classList.add('draggable');

    container.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.pageX - container.offsetLeft;
        scrollLeft = container.scrollLeft;
        container.style.cursor = 'grabbing';
    });

    container.addEventListener('mouseleave', () => {
        isDragging = false;
        container.style.cursor = 'grab';
    });

    container.addEventListener('mouseup', () => {
        isDragging = false;
        container.style.cursor = 'grab';
    });

    container.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        e.preventDefault();
        
        const x = e.pageX - container.offsetLeft;
        const walk = (x - startX) * 2; // –°–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        container.scrollLeft = scrollLeft - walk;
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
document.getElementById('okrFilter').addEventListener('change', () => {
    loadTasks().then(tasks => {
        renderGantt(tasks);
        generateStaffStats(tasks);
    });
});

document.getElementById('ownerFilter').addEventListener('change', () => {
    loadTasks().then(tasks => {
        renderGantt(tasks);
        generateStaffStats(tasks);
    });
});

document.getElementById('periodFilter').addEventListener('change', () => {
    loadTasks().then(tasks => {
        renderGantt(tasks);
        generateStaffStats(tasks);
    });
});

document.getElementById('toggleView').addEventListener('click', function() {
    if (currentView === 'monthly') {
        currentView = 'quarterly';
        this.textContent = '–ü–æ–º–µ—Å—è—á–Ω–æ';
    } else {
        currentView = 'monthly';
        this.textContent = '–ö–≤–∞—Ä—Ç–∞–ª—å–Ω–æ';
    }
    this.classList.toggle('active');
    loadTasks().then(tasks => renderGantt(tasks));
});

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–ª–∏–∫—É –Ω–∞ –ª–µ–≥–µ–Ω–¥—É
document.querySelectorAll('.legend-item').forEach(item => {
    item.addEventListener('click', function() {
        const okr = this.getAttribute('data-okr');
        
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ª–µ–≥–µ–Ω–¥—ã
        document.querySelectorAll('.legend-item').forEach(i => {
            i.classList.remove('filtered');
        });
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ç–æ—Ç –∂–µ OKR, —á—Ç–æ –∏ —Ä–∞–Ω—å—à–µ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
        if (document.getElementById('okrFilter').value === okr) {
            document.getElementById('okrFilter').value = 'all';
        } else {
            // –ò–Ω–∞—á–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä –∏ –æ—Ç–º–µ—á–∞–µ–º –¥—Ä—É–≥–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∫–∞–∫ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ
            document.getElementById('okrFilter').value = okr;
            document.querySelectorAll('.legend-item').forEach(i => {
                if (i.getAttribute('data-okr') !== okr) {
                    i.classList.add('filtered');
                }
            });
        }
        
        loadTasks().then(tasks => {
            renderGantt(tasks);
            generateStaffStats(tasks);
        });
    });
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    document.getElementById('adminButton').addEventListener('click', function() {
        window.location.href = 'login.php';
    });
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
    setupDragToScroll();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
    loadTasks().then(tasks => {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
        updateTaskStatuses(tasks);
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É 2025 –≥–æ–¥–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const today = getCurrentDateFor2025Demo();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–µ –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const dateInfo = document.createElement('div');
        dateInfo.className = 'current-date-info';
        dateInfo.innerHTML = `
            <div style="margin-top: 10px; font-size: 0.9em; color: #777;">
                –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: <strong>${formatDate(today)}</strong>
            </div>
        `;
        document.querySelector('.title').appendChild(dateInfo);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
        populateOwnerFilter(tasks);
        renderGantt(tasks);
        generateStaffStats(tasks);
    });
});
</script>
</body>
</html> 